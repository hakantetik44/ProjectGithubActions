variables:
 MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
 FF_USE_LEGACY_ARTIFACTS_UPLOAD: "true"
 SELENIUM_URL: "http://selenium-chrome:4444/wd/hub"
 CHROME_OPTIONS: "--headless --no-sandbox --disable-dev-shm-usage --disable-gpu --window-size=1920,1080"
 CUCUMBER_PUBLISH_ENABLED: "true" 

image: maven:3.9.6-eclipse-temurin-17

services:
 - name: selenium/standalone-chrome:latest
   alias: selenium-chrome

cache:
 paths:
   - .m2/repository
 key: "$CI_COMMIT_REF_SLUG"

stages:
 - test
 - report
 - deploy

test:
 stage: test
 before_script:
   - apt-get update && apt-get install -y jq
 script:
   - echo "ğŸš€ Tests baÅŸlatÄ±lÄ±yor..."
   - echo "âš™ï¸ Maven ayarlarÄ± yapÄ±landÄ±rÄ±lÄ±yor..."
   - |
     export MAVEN_OPTS="$MAVEN_OPTS \
       -Dselenium.grid.url=$SELENIUM_URL \
       -Dwebdriver.chrome.whitelistedIps= \
       -Dcucumber.publish.quiet=false \
       -Dwebdriver.timeouts.implicitlywait=30000 \
       -Dwebdriver.timeouts.pageLoadTimeout=30000"

   - echo "ğŸ§ª Testler Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
   - |
     echo "ğŸ“‹ Test SenaryolarÄ±:"
     echo "-------------------"
     mvn clean test -B -Dtest=TestRunner \
       -Dcucumber.plugin="pretty,usage,html:target/cucumber-reports/report.html,json:target/cucumber-reports/cucumber.json,io.qameta.allure.cucumber7jvm.AllureCucumber7Jvm,progress,rerun:target/failed_scenarios.txt,testng:target/cucumber-reports/cucumber-results.xml" \
       -Dcucumber.execution.dry-run=false \
       -Dcucumber.execution.strict=true \
       -Dcucumber.execution.parallel.enabled=false \
       -Dcucumber.ansi-colors.disabled=false \
       -Dcucumber.filter.tags="not @ignore" \
       -Dcucumber.monochrome=false \
       -Dcucumber.pretty=true \
       -Dmaven.test.failure.ignore=true \
       -Dselenium.grid.url=$SELENIUM_URL \
       -Dcucumber.publish.enabled=true \
       -X || true

   - echo "ğŸ“Š Test SonuÃ§larÄ±:"
   - |
     if [ -f "target/cucumber-reports/cucumber.json" ]; then
       echo ""
       echo "ğŸ” Test AdÄ±mlarÄ±:"
       echo "---------------"
       jq -r '.[] | 
         .name as $feature |
         .elements[] |
         "Feature: \($feature)\n" +
         "  Scenario: " + .name + "\n" +
         (.steps[] | "    " + .keyword + .name + " - " + .result.status)
       ' target/cucumber-reports/cucumber.json |
       while IFS= read -r line; do
         if [[ $line == *"passed"* ]]; then
           echo "âœ… ${line% - passed}"
         elif [[ $line == *"failed"* ]]; then
           echo "âŒ ${line% - failed}"
         elif [[ $line == *"skipped"* ]]; then
           echo "â­ï¸ ${line% - skipped}"
         elif [[ $line == Feature* ]]; then
           echo "ğŸŒŸ $line"
         elif [[ $line == *Scenario* ]]; then
           echo "ğŸ“ $line"
         else
           echo "$line"
         fi
       done

       echo ""
       echo "ğŸ“ˆ Test Ä°statistikleri:"
       PASSED=$(jq '[.[] | .elements[] | .steps[] | select(.result.status == "passed")] | length' target/cucumber-reports/cucumber.json)
       FAILED=$(jq '[.[] | .elements[] | .steps[] | select(.result.status == "failed")] | length' target/cucumber-reports/cucumber.json)
       SKIPPED=$(jq '[.[] | .elements[] | .steps[] | select(.result.status == "skipped")] | length' target/cucumber-reports/cucumber.json)
       TOTAL=$((PASSED + FAILED + SKIPPED))
       
       echo "âœ… BaÅŸarÄ±lÄ± AdÄ±m: $PASSED / $TOTAL"
       echo "âŒ BaÅŸarÄ±sÄ±z AdÄ±m: $FAILED / $TOTAL"
       echo "â­ï¸ Atlanan AdÄ±m: $SKIPPED / $TOTAL"
       
       # Test Ã¶zeti oluÅŸtur
       {
         echo "Test Ã–zeti"
         echo "=========="
         echo "Tarih: $(date)"
         echo "Branch: $CI_COMMIT_REF_NAME"
         echo "Commit: $CI_COMMIT_SHA"
         echo ""
         echo "SonuÃ§lar:"
         echo "âœ… BaÅŸarÄ±lÄ±: $PASSED / $TOTAL"
         echo "âŒ BaÅŸarÄ±sÄ±z: $FAILED / $TOTAL"
         echo "â­ï¸ Atlanan: $SKIPPED / $TOTAL"
         
         echo ""
         echo "DetaylÄ± AdÄ±mlar:"
         jq -r '.[] | .elements[] | .steps[] | "  " + .keyword + " " + .name + " - " + .result.status' target/cucumber-reports/cucumber.json
       } > test_summary.txt
     else
       echo "âš ï¸ Test sonuÃ§larÄ± bulunamadÄ±!"
     fi

   - echo "ğŸ“‹ Allure raporu oluÅŸturuluyor..."
   - mvn allure:report || true
   - echo "âœ… Test aÅŸamasÄ± tamamlandÄ±"

 artifacts:
   when: always
   reports:
     junit:
       - target/surefire-reports/TEST-*.xml
   paths:
     - target/allure-results/
     - target/allure-report/
     - target/cucumber-reports/
     - target/surefire-reports/
     - test_summary.txt
   expire_in: 1 week

allure-report:
 stage: report
 script:
   - echo "ğŸ“ Dizinler oluÅŸturuluyor..."
   - mkdir -p public/cucumber-report public/allure-report
   - echo "ğŸ“‹ Raporlar kopyalanÄ±yor..."
   - cp -r target/cucumber-reports/* public/cucumber-report/ || true
   - cp -r target/allure-report/* public/allure-report/ || true
   - cp test_summary.txt public/ || true
   - echo "ğŸ¨ Index sayfasÄ± oluÅŸturuluyor..."
   - |
     cat << 'EOF' > public/index.html
     <!DOCTYPE html>
     <html>
     <head>
         <meta charset="utf-8">
         <title>ğŸ” Test RaporlarÄ±</title>
         <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
         <style>
             body { 
                 font-family: Arial, sans-serif; 
                 margin: 40px;
                 background: #f5f5f5;
             }
             h1 { 
                 color: #333;
                 text-align: center;
                 margin-bottom: 30px;
             }
             .reports {
                 max-width: 600px;
                 margin: 20px auto;
                 background: white;
                 padding: 20px;
                 border-radius: 10px;
                 box-shadow: 0 2px 5px rgba(0,0,0,0.1);
             }
             .report-link {
                 display: flex;
                 align-items: center;
                 color: #0366d6;
                 text-decoration: none;
                 padding: 15px;
                 margin: 10px 0;
                 border-radius: 5px;
                 transition: all 0.3s ease;
             }
             .report-link:hover {
                 background: #f6f8fa;
                 transform: translateX(5px);
             }
             .report-link i {
                 margin-right: 10px;
                 font-size: 24px;
             }
             .dashboard {
                 display: grid;
                 grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                 gap: 20px;
                 margin-bottom: 30px;
             }
             .stat-card {
                 background: white;
                 padding: 20px;
                 border-radius: 8px;
                 text-align: center;
                 box-shadow: 0 2px 5px rgba(0,0,0,0.1);
             }
             .stat-card i {
                 font-size: 30px;
                 margin-bottom: 10px;
                 color: #0366d6;
             }
         </style>
     </head>
     <body>
         <h1>ğŸ“Š Test RaporlarÄ± Dashboard</h1>
         <div class="dashboard">
             <div class="stat-card">
                 <i class="fas fa-vial"></i>
                 <h3>Test SonuÃ§larÄ±</h3>
                 <p id="testResults">YÃ¼kleniyor...</p>
             </div>
             <div class="stat-card">
                 <i class="fas fa-code-branch"></i>
                 <h3>Branch</h3>
                 <p>${CI_COMMIT_REF_NAME}</p>
             </div>
             <div class="stat-card">
                 <i class="fas fa-clock"></i>
                 <h3>Tarih</h3>
                 <p id="currentDate"></p>
             </div>
             <div class="stat-card">
                 <i class="fas fa-check-circle"></i>
                 <h3>Test Durumu</h3>
                 <p id="testStatus">YÃ¼kleniyor...</p>
             </div>
         </div>
         <div class="reports">
             <a href="./allure-report/index.html" class="report-link">
                 <i class="fas fa-chart-bar"></i>
                 Allure Report - DetaylÄ± Test Raporu
             </a>
             <a href="./cucumber-report/report.html" class="report-link">
                 <i class="fas fa-file-alt"></i>
                 Cucumber Report - BDD Test SonuÃ§larÄ±
             </a>
             <a href="./test_summary.txt" class="report-link">
                 <i class="fas fa-file-text"></i>
                 Test Ã–zeti
             </a>
         </div>
         <script>
             document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
             
             fetch('test_summary.txt')
               .then(response => response.text())
               .then(data => {
                   const lines = data.split('\n');
                   const results = lines.find(line => line.includes('âœ…'));
                   if (results) {
                       document.getElementById('testResults').innerHTML = results;
                   }
                   
                   const passed = parseInt(results.match(/\d+/)[0]);
                   const total = parseInt(results.match(/\d+/g)[1]);
                   const failed = total - passed;
                   
                   document.getElementById('testStatus').innerHTML = failed === 0 
                       ? 'âœ… TÃ¼m Testler BaÅŸarÄ±lÄ±'
                       : `âŒ ${failed} Test BaÅŸarÄ±sÄ±z`;
               })
               .catch(() => {
                   document.getElementById('testResults').textContent = 'SonuÃ§ BulunamadÄ±';
                   document.getElementById('testStatus').textContent = 'Durum Bilinmiyor';
               });
         </script>
     </body>
     </html>
     EOF
   - echo "âœ¨ Raporlama tamamlandÄ±"
 artifacts:
   paths:
     - public
   expire_in: 30 days
 dependencies:
   - test

pages:
 stage: deploy
 script:
   - echo "ğŸš€ Pages daÄŸÄ±tÄ±mÄ± baÅŸlÄ±yor..."
   - echo "ğŸ“¦ Raporlar yayÄ±nlanÄ±yor..."
   - echo "âœ… DaÄŸÄ±tÄ±m tamamlandÄ±"
 artifacts:
   paths:
     - public
   expire_in: 30 days
 dependencies:
   - allure-report
 only:
   - main